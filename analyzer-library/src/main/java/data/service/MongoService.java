package data.service;

import com.mongodb.MongoClient;
import com.mongodb.MongoClientSettings;
import com.mongodb.MongoClientURI;
import com.mongodb.client.MongoCollection;
import com.mongodb.client.MongoCursor;
import com.mongodb.client.MongoDatabase;
import com.mongodb.client.model.Filters;
import org.bson.codecs.configuration.CodecRegistries;
import org.bson.codecs.pojo.PojoCodecProvider;
import vulnerabilities.rule.Rule;

import java.util.ArrayList;
import java.util.List;

public class MongoService {

    private static final String MONGO_URI = "mongodb+srv://root:admin@cluster0.h6ker.mongodb.net/test";
    private static final String DB_NAME = "root";
    private static final String COLLECTION_NAME = "vulnerability";

    private final MongoCollection<Rule> mongoCollection = getMongoCollection();

    private MongoCollection<Rule> getMongoCollection() {
        MongoClient client = new MongoClient(new MongoClientURI(MONGO_URI));
        MongoDatabase database = client.getDatabase(DB_NAME);

        return database.withCodecRegistry(CodecRegistries.fromRegistries(
                MongoClientSettings.getDefaultCodecRegistry(),
                CodecRegistries.fromProviders(PojoCodecProvider.builder().automatic(true).build())
        )).getCollection(COLLECTION_NAME, Rule.class);
    }

    public List<Rule> getRulesByVulnerability(String vulnerabilityName) {
        MongoCursor<Rule> cur = mongoCollection.find(Filters.eq("vulnerabilityName", vulnerabilityName)).cursor();
        List<Rule> rules = new ArrayList<>();
        while(cur.hasNext()) {
            rules.add(cur.next());
        }
        return rules;
    }

    public void addRules(List<Rule> rules) {
        mongoCollection.insertMany(rules);
    }
}
