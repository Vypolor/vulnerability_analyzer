package data.service;

import com.mongodb.MongoClient;
import com.mongodb.MongoClientSettings;
import com.mongodb.MongoClientURI;
import com.mongodb.client.MongoCollection;
import com.mongodb.client.MongoDatabase;
import com.mongodb.client.model.Filters;
import data.entity.VulnerabilityEntity;
import org.bson.codecs.configuration.CodecRegistries;
import org.bson.codecs.pojo.PojoCodecProvider;
import vulnerabilities.rule.Rule;

import java.util.Collections;
import java.util.List;

public class MongoService {

    private static final String MONGO_URI = "mongodb+srv://root:admin@cluster0.h6ker.mongodb.net/test";
    private static final String DB_NAME = "root";
    private static final String COLLECTION_NAME = "vulnerability";

    private final MongoCollection<VulnerabilityEntity> mongoCollection = getMongoCollection();

    private MongoCollection<VulnerabilityEntity> getMongoCollection() {
        MongoClient client = new MongoClient(new MongoClientURI(MONGO_URI));
        MongoDatabase database = client.getDatabase(DB_NAME);

        return database.withCodecRegistry(CodecRegistries.fromRegistries(
                MongoClientSettings.getDefaultCodecRegistry(),
                CodecRegistries.fromProviders(PojoCodecProvider.builder().automatic(true).build())
        )).getCollection(COLLECTION_NAME, VulnerabilityEntity.class);
    }

    public List<Rule> getRulesByVulnerability(String vulnerabilityName) {
        VulnerabilityEntity entity = getVulnerabilityEntity(vulnerabilityName);
        if (entity != null)
            return entity.getRules();
        return Collections.emptyList();
    }

    public VulnerabilityEntity addVulnerabilityEntity(VulnerabilityEntity entity) {
        mongoCollection.insertOne(entity);
        return entity;
    }

    public VulnerabilityEntity deleteVulnerabilityEntity(String vulnerabilityName) {
        VulnerabilityEntity toDelete = getVulnerabilityEntity(vulnerabilityName);
        mongoCollection.deleteOne(Filters.eq("vulnerabilityName", vulnerabilityName));
        return toDelete;
    }

    private VulnerabilityEntity getVulnerabilityEntity(String vulnerabilityName) {
        return mongoCollection.find(Filters.eq("vulnerabilityName", vulnerabilityName)).first();
    }
}
